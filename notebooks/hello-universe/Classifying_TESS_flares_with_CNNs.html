
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classifying flaring stars with stella: a convolutional neural network for TESS &#8212; Notebook Repository Demo</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Notebook Repository Demo</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   STScI Notebook Repository Template
  </a>
 </li>
</ul>
    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/hello-universe/Classifying_TESS_flares_with_CNNs.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/TheRealZoidberg/demoTest"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/TheRealZoidberg/demoTest/issues/new?title=Issue%20on%20page%20%2Fnotebooks/hello-universe/Classifying_TESS_flares_with_CNNs.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/TheRealZoidberg/demoTest/master?urlpath=tree/docs/notebooks/hello-universe/Classifying_TESS_flares_with_CNNs.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-goals">
   Learning Goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convolutional-neural-network-cnn-for-vector-classification">
   Convolutional Neural Network (CNN)  for Vector Classification
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-training-data-using-stella">
     1. Download the training data using
     <code class="docutils literal notranslate">
      <span class="pre">
       stella
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-a-cnn-in-keras">
     3. Build a CNN in
     <code class="docutils literal notranslate">
      <span class="pre">
       Keras
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compile-the-cnn">
     4. Compile the CNN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-cnn-to-perform-a-classification-task">
     5. Train the CNN to perform a classification task
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-the-cnn-performance">
     6. Test the CNN performance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#faq">
   FAQ
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extensions-exercises">
   Extensions/Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#predict-flares-in-a-new-dataset">
     7. Predict flares in a new dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   FAQ
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about-this-notebook">
   About this Notebook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#citations">
   Citations
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Classifying flaring stars with stella: a convolutional  neural network for TESS</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#learning-goals">
   Learning Goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports">
   Imports
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#convolutional-neural-network-cnn-for-vector-classification">
   Convolutional Neural Network (CNN)  for Vector Classification
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-training-data-using-stella">
     1. Download the training data using
     <code class="docutils literal notranslate">
      <span class="pre">
       stella
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-a-cnn-in-keras">
     3. Build a CNN in
     <code class="docutils literal notranslate">
      <span class="pre">
       Keras
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compile-the-cnn">
     4. Compile the CNN
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-cnn-to-perform-a-classification-task">
     5. Train the CNN to perform a classification task
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-the-cnn-performance">
     6. Test the CNN performance
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#faq">
   FAQ
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extensions-exercises">
   Extensions/Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#predict-flares-in-a-new-dataset">
     7. Predict flares in a new dataset
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   FAQ
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#about-this-notebook">
   About this Notebook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#citations">
   Citations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <p><a id="top"></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="classifying-flaring-stars-with-stella-a-convolutional-neural-network-for-tess">
<h1>Classifying flaring stars with stella: a convolutional  neural network for TESS<a class="headerlink" href="#classifying-flaring-stars-with-stella-a-convolutional-neural-network-for-tess" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<div class="section" id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Permalink to this headline">¶</a></h2>
<p><strong>In this tutorial, you will see an example of building, compiling, and training a CNN to classify astronomical data in vector form.</strong>
By the end of this tutorial you will have a working example of a simple Convolutional Neural Network (CNN) in <code class="docutils literal notranslate"><span class="pre">Keras</span></code>.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>CNNs are a class of machine learning (ML) algorithms that can extract information from data. In this notebook, you will walk through the basic steps of applying a CNN to data:</p>
<ol class="simple">
<li><p>Load the data and visualize a sample of the data.</p></li>
<li><p>Divide the data into training, validation, and testing sets.</p></li>
<li><p>Build a CNN in <code class="docutils literal notranslate"><span class="pre">Keras</span></code>.</p></li>
<li><p>Compile the CNN.</p></li>
<li><p>Train the CNN to perform a classification task.</p></li>
<li><p>Evaluate the CNN performance on test data with a confusion matrix.</p></li>
<li><p>Build a new, unlabeled dataset and apply the CNN.</p></li>
</ol>
<p>CNNs can be applied to a wide range of vector analysis tasks, including classification and regression.
Here, we will build, compile, and train CNN to classify whether a star has undergone a flaring event from its observed TESS 2-minute light curve, and where the flaring events are located within the time series.
This work is based on the model described in the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2347F/abstract"><code class="docutils literal notranslate"><span class="pre">stella</span></code></a> software package.</p>
<p><strong>NOTE:</strong> <em>The <a class="reference external" href="https://adina.feinste.in/stella/"><code class="docutils literal notranslate"><span class="pre">stella</span></code> team has publicly-available code and documentation</a> for demonstrating the architecture and optimal performance of this model, which we encourage you to check out!
The goal of this notebook is to step through the model building and training process.</em></p>
</div>
<div class="section" id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h2>
<p>This notebook uses the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> to handle array functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tarfile</span></code> for unpacking files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> for accessing FITS files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib.pyplot</span></code> for plotting data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stella</span></code> for generating the training set and processing data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">keras</span></code> for building the CNN</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> for model performance metrics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lightkurve.search</span></code> for extracting light curves</p></li>
</ul>
<p>If you do not have these packages installed, you can install them using <code class="docutils literal notranslate"><span class="pre">pip</span></code> or <code class="docutils literal notranslate"><span class="pre">conda</span></code>.
You can refer to the webpages for each of those modules for further installation instructions.</p>
<p>To download the <code class="docutils literal notranslate"><span class="pre">stella</span></code> package, see their <a class="reference external" href="https://adina.feinste.in/stella/getting_started/installation.html">documentation</a>.</p>
<p>To download the <code class="docutils literal notranslate"><span class="pre">lightkurve</span></code> package, see their <a class="reference external" href="https://docs.lightkurve.org/about/install.html">documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># unpacking files</span>
<span class="kn">import</span> <span class="nn">tarfile</span>

<span class="c1"># fits</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>

<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span>

<span class="c1"># stella CNN functions</span>
<span class="kn">import</span> <span class="nn">stella</span>

<span class="c1"># keras</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">keras.layers.convolutional</span> <span class="kn">import</span> <span class="n">Convolution1D</span><span class="p">,</span> <span class="n">MaxPooling1D</span>

<span class="c1"># sklearn for performance metrics</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>

<span class="c1"># lightkurve</span>
<span class="kn">from</span> <span class="nn">lightkurve.search</span> <span class="kn">import</span> <span class="n">search_lightcurve</span>

<span class="c1"># from IPython import get_ipython</span>
<span class="c1"># get_ipython().run_line_magic(&#39;matplotlib&#39;, &#39;notebook&#39;)</span>

<span class="c1"># set random seed for reproducibility </span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-06-02 15:44:47.234247: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.8.12/x64/lib
2022-06-02 15:44:47.234287: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [1],</span> in <span class="ni">&lt;cell line: 16&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="c1"># stella CNN functions</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">import</span> <span class="nn">stella</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="c1"># keras</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">load_model</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">stella</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">PACKAGEDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">.version</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="kn">from</span> <span class="nn">.neural_network</span>            <span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">.preprocessing_flares</span>      <span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="c1">#from .preprocessing_transits    import *</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">stella</span><span class="o">/</span><span class="n">neural_network</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">37</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span> <span class="kn">import</span> <span class="nn">sys</span> <span class="k">as</span> <span class="nn">_sys</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">_typing</span>
<span class="ne">---&gt; </span><span class="mi">37</span> <span class="kn">from</span> <span class="nn">tensorflow.python.tools</span> <span class="kn">import</span> <span class="n">module_util</span> <span class="k">as</span> <span class="n">_module_util</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span> <span class="kn">from</span> <span class="nn">tensorflow.python.util.lazy_loader</span> <span class="kn">import</span> <span class="n">LazyLoader</span> <span class="k">as</span> <span class="n">_LazyLoader</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> <span class="c1"># Make sure code inside the TensorFlow codebase can use tf2.enabled() at import.</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">37</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="c1"># We aim to keep this file minimal and ideally remove completely.</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> <span class="c1"># If you are adding a new file with @tf_export decorators,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="c1"># import it in modules_with_exports.py instead.</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> 
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="c1"># go/tf-wildcard-import</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span> <span class="c1"># pylint: disable=wildcard-import,g-bad-import-order,g-import-not-at-top</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span> <span class="kn">from</span> <span class="nn">tensorflow.python</span> <span class="kn">import</span> <span class="n">pywrap_tensorflow</span> <span class="k">as</span> <span class="n">_pywrap_tensorflow</span>
<span class="ne">---&gt; </span><span class="mi">37</span> <span class="kn">from</span> <span class="nn">tensorflow.python.eager</span> <span class="kn">import</span> <span class="n">context</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span> <span class="c1"># pylint: enable=wildcard-import</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> 
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="c1"># Bring in subpackages.</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="kn">from</span> <span class="nn">tensorflow.python</span> <span class="kn">import</span> <span class="n">data</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">eager</span><span class="o">/</span><span class="n">context</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">29</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="kn">import</span> <span class="nn">six</span>
<span class="ne">---&gt; </span><span class="mi">29</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">function_pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> <span class="kn">from</span> <span class="nn">tensorflow.core.protobuf</span> <span class="kn">import</span> <span class="n">config_pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="kn">from</span> <span class="nn">tensorflow.core.protobuf</span> <span class="kn">import</span> <span class="n">coordination_config_pb2</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">framework</span><span class="o">/</span><span class="n">function_pb2</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># @@protoc_insertion_point(imports)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">_sym_db</span> <span class="o">=</span> <span class="n">_symbol_database</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">attr_value_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_attr__value__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">node_def_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_node__def__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">op_def_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_op__def__pb2</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">framework</span><span class="o">/</span><span class="n">attr_value_pb2</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># @@protoc_insertion_point(imports)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">_sym_db</span> <span class="o">=</span> <span class="n">_symbol_database</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">tensor_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_tensor__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">tensor_shape_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_tensor__shape__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">types_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_types__pb2</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">framework</span><span class="o">/</span><span class="n">tensor_pb2</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># @@protoc_insertion_point(imports)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">_sym_db</span> <span class="o">=</span> <span class="n">_symbol_database</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">resource_handle_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_resource__handle__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">tensor_shape_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_tensor__shape__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">types_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_types__pb2</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">framework</span><span class="o">/</span><span class="n">resource_handle_pb2</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># @@protoc_insertion_point(imports)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">_sym_db</span> <span class="o">=</span> <span class="n">_symbol_database</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">tensor_shape_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_tensor__shape__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">from</span> <span class="nn">tensorflow.core.framework</span> <span class="kn">import</span> <span class="n">types_pb2</span> <span class="k">as</span> <span class="n">tensorflow_dot_core_dot_framework_dot_types__pb2</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="n">DESCRIPTOR</span> <span class="o">=</span> <span class="n">_descriptor</span><span class="o">.</span><span class="n">FileDescriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tensorflow/core/framework/resource_handle.proto&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>   <span class="n">package</span><span class="o">=</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>   <span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>   <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">tensorflow_dot_core_dot_framework_dot_tensor__shape__pb2</span><span class="o">.</span><span class="n">DESCRIPTOR</span><span class="p">,</span><span class="n">tensorflow_dot_core_dot_framework_dot_types__pb2</span><span class="o">.</span><span class="n">DESCRIPTOR</span><span class="p">,])</span>

<span class="n">File</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.9</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">tensorflow</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">framework</span><span class="o">/</span><span class="n">tensor_shape_pb2</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">_sym_db</span> <span class="o">=</span> <span class="n">_symbol_database</span><span class="o">.</span><span class="n">Default</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="n">DESCRIPTOR</span> <span class="o">=</span> <span class="n">_descriptor</span><span class="o">.</span><span class="n">FileDescriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span>   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tensorflow/core/framework/tensor_shape.proto&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>   <span class="n">package</span><span class="o">=</span><span class="s1">&#39;tensorflow&#39;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>   <span class="n">serialized_pb</span><span class="o">=</span><span class="n">_b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">,tensorflow/core/framework/tensor_shape.proto</span><span class="se">\x12\n</span><span class="s1">tensorflow</span><span class="se">\&quot;</span><span class="s1">z</span><span class="se">\n\x10</span><span class="s1">TensorShapeProto</span><span class="se">\x12</span><span class="s1">-</span><span class="se">\n\x03\x64</span><span class="s1">im</span><span class="se">\x18\x02</span><span class="s1"> </span><span class="se">\x03</span><span class="s1">(</span><span class="se">\x0b\x32</span><span class="s1"> .tensorflow.TensorShapeProto.Dim</span><span class="se">\x12\x14\n\x0c</span><span class="s1">unknown_rank</span><span class="se">\x18\x03</span><span class="s1"> </span><span class="se">\x01</span><span class="s1">(</span><span class="se">\x08\x1a</span><span class="s1">!</span><span class="se">\n\x03\x44</span><span class="s1">im</span><span class="se">\x12\x0c\n\x04</span><span class="s1">size</span><span class="se">\x18\x01</span><span class="s1"> </span><span class="se">\x01</span><span class="s1">(</span><span class="se">\x03\x12\x0c\n\x04</span><span class="s1">name</span><span class="se">\x18\x02</span><span class="s1"> </span><span class="se">\x01</span><span class="s1">(</span><span class="se">\t</span><span class="s1">B</span><span class="se">\x87\x01\n\x18</span><span class="s1">org.tensorflow.frameworkB</span><span class="se">\x11</span><span class="s1">TensorShapeProtosP</span><span class="se">\x01</span><span class="s1">ZSgithub.com/tensorflow/tensorflow/tensorflow/go/core/framework/tensor_shape_go_proto</span><span class="se">\xf8\x01\x01\x62\x06</span><span class="s1">proto3&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="n">_TENSORSHAPEPROTO_DIM</span> <span class="o">=</span> <span class="n">_descriptor</span><span class="o">.</span><span class="n">Descriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dim&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>   <span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;tensorflow.TensorShapeProto.Dim&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>   <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>   <span class="n">file</span><span class="o">=</span><span class="n">DESCRIPTOR</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>   <span class="n">containing_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>   <span class="n">fields</span><span class="o">=</span><span class="p">[</span>
<span class="ne">---&gt; </span><span class="mi">36</span>     <span class="n">_descriptor</span><span class="o">.</span><span class="n">FieldDescriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span>       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;tensorflow.TensorShapeProto.Dim.size&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>       <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cpp_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span>       <span class="n">has_default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span>       <span class="n">message_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enum_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">containing_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span>       <span class="n">is_extension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span>       <span class="n">serialized_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">DESCRIPTOR</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span>     <span class="n">_descriptor</span><span class="o">.</span><span class="n">FieldDescriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;tensorflow.TensorShapeProto.Dim.name&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span>       <span class="n">number</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">cpp_type</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span>       <span class="n">has_default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">_b</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">47</span>       <span class="n">message_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enum_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">containing_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span>       <span class="n">is_extension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">49</span>       <span class="n">serialized_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">DESCRIPTOR</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>   <span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="n">extensions</span><span class="o">=</span><span class="p">[</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span>   <span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>   <span class="n">nested_types</span><span class="o">=</span><span class="p">[],</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span>   <span class="n">enum_types</span><span class="o">=</span><span class="p">[</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span>   <span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>   <span class="n">serialized_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>   <span class="n">is_extendable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">58</span>   <span class="n">syntax</span><span class="o">=</span><span class="s1">&#39;proto3&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>   <span class="n">extension_ranges</span><span class="o">=</span><span class="p">[],</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span>   <span class="n">oneofs</span><span class="o">=</span><span class="p">[</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>   <span class="p">],</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>   <span class="n">serialized_start</span><span class="o">=</span><span class="mi">149</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>   <span class="n">serialized_end</span><span class="o">=</span><span class="mi">182</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span> <span class="n">_TENSORSHAPEPROTO</span> <span class="o">=</span> <span class="n">_descriptor</span><span class="o">.</span><span class="n">Descriptor</span><span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TensorShapeProto&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span>   <span class="n">full_name</span><span class="o">=</span><span class="s1">&#39;tensorflow.TensorShapeProto&#39;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span>   <span class="n">serialized_end</span><span class="o">=</span><span class="mi">182</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span> <span class="n">_TENSORSHAPEPROTO_DIM</span><span class="o">.</span><span class="n">containing_type</span> <span class="o">=</span> <span class="n">_TENSORSHAPEPROTO</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/google/protobuf/descriptor.py:560,</span> in <span class="ni">FieldDescriptor.__new__</span><span class="nt">(cls, name, full_name, index, number, type, cpp_type, label, default_value, message_type, enum_type, containing_type, is_extension, extension_scope, options, serialized_options, has_default_value, containing_oneof, json_name, file, create_key)</span>
<span class="g g-Whitespace">    </span><span class="mi">554</span> <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">cpp_type</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">555</span>             <span class="n">default_value</span><span class="p">,</span> <span class="n">message_type</span><span class="p">,</span> <span class="n">enum_type</span><span class="p">,</span> <span class="n">containing_type</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span>             <span class="n">is_extension</span><span class="p">,</span> <span class="n">extension_scope</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span>             <span class="n">serialized_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">558</span>             <span class="n">has_default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">containing_oneof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">559</span>             <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">create_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
<span class="ne">--&gt; </span><span class="mi">560</span>   <span class="n">_message</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">_CheckCalledFromGeneratedFile</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">561</span>   <span class="k">if</span> <span class="n">is_extension</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">562</span>     <span class="k">return</span> <span class="n">_message</span><span class="o">.</span><span class="n">default_pool</span><span class="o">.</span><span class="n">FindExtensionByName</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>

<span class="ne">TypeError</span>: Descriptors cannot not be created directly.
<span class="n">If</span> <span class="n">this</span> <span class="n">call</span> <span class="n">came</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">_pb2</span><span class="o">.</span><span class="n">py</span> <span class="n">file</span><span class="p">,</span> <span class="n">your</span> <span class="n">generated</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span> <span class="ow">and</span> <span class="n">must</span> <span class="n">be</span> <span class="n">regenerated</span> <span class="k">with</span> <span class="n">protoc</span> <span class="o">&gt;=</span> <span class="mf">3.19.0</span><span class="o">.</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">cannot</span> <span class="n">immediately</span> <span class="n">regenerate</span> <span class="n">your</span> <span class="n">protos</span><span class="p">,</span> <span class="n">some</span> <span class="n">other</span> <span class="n">possible</span> <span class="n">workarounds</span> <span class="n">are</span><span class="p">:</span>
<span class="g g-Whitespace"> </span><span class="mi">1</span><span class="o">.</span> <span class="n">Downgrade</span> <span class="n">the</span> <span class="n">protobuf</span> <span class="n">package</span> <span class="n">to</span> <span class="mf">3.20</span><span class="o">.</span><span class="n">x</span> <span class="ow">or</span> <span class="n">lower</span><span class="o">.</span>
<span class="g g-Whitespace"> </span><span class="mi">2</span><span class="o">.</span> <span class="n">Set</span> <span class="n">PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION</span><span class="o">=</span><span class="n">python</span> <span class="p">(</span><span class="n">but</span> <span class="n">this</span> <span class="n">will</span> <span class="n">use</span> <span class="n">pure</span><span class="o">-</span><span class="n">Python</span> <span class="n">parsing</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">much</span> <span class="n">slower</span><span class="p">)</span><span class="o">.</span>

<span class="n">More</span> <span class="n">information</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">developers</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">protocol</span><span class="o">-</span><span class="n">buffers</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">news</span><span class="o">/</span><span class="mi">2022</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">06</span><span class="c1">#python-updates</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="convolutional-neural-network-cnn-for-vector-classification">
<h2>Convolutional Neural Network (CNN)  for Vector Classification<a class="headerlink" href="#convolutional-neural-network-cnn-for-vector-classification" title="Permalink to this headline">¶</a></h2>
<div class="section" id="download-the-training-data-using-stella">
<h3>1. Download the training data using <code class="docutils literal notranslate"><span class="pre">stella</span></code><a class="headerlink" href="#download-the-training-data-using-stella" title="Permalink to this headline">¶</a></h3>
<p>Load the sample of TESS lightcurves (input vectors) and flare classifications (output labels) to be used to train the CNN from the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2347F/abstract"><code class="docutils literal notranslate"><span class="pre">stella</span></code></a> package.
<code class="docutils literal notranslate"><span class="pre">stella</span></code> pre-processes the light curves and splits the data into training, test and validation sets.</p>
<p>The training set contains stars observed at 2-minute cadence in TESS Sectors 1 and 2, classified by hand and presented as a flare catalog by <a href='https://ui.adsabs.harvard.edu/abs/2020AJ....159...60G/abstract'>Gunther et al. 2020</a>.
The light curves are processed into examples of length 200 cadences, where each flaring event, if present, is located at the center of the example. The full sample of lightcurves contains 8694 positive classes (flare), and 35896 negative classes (no flare).
For this notebook, we will download a subset of this sample.
These data are described in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">Feinstein et al. 2020</a>.</p>
<p>The CNN will be used to predict the presence of flaring events as a function of observing cadence.
The input to the CNN is a light curve (time, flux, and flux error) and the output is a “probability light curve”, or probabilities (value between 0 and 1) that the measurement at each cadence is of a flaring event (1=flare, 0=no flare).
In other words, the CNN performs a <strong>classification</strong> task at each cadence.
Before a probability light curve can be produced, <code class="docutils literal notranslate"><span class="pre">stella</span></code> first pre-processes the input light curve by assembling it into examples of length 200 cadences, so that the model can predict a value for the flare probability at each valid cadence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">file_url</span> <span class="o">=</span> <span class="s1">&#39;https://archive.stsci.edu/hlsps/hellouniverse/hellouniverse_stella_500.tar.gz&#39;</span>

<span class="c1"># open file</span>
<span class="n">file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">download_file</span><span class="p">(</span><span class="n">file_url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
  
<span class="c1"># extracting file</span>
<span class="n">file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 212 ms, sys: 61.1 ms, total: 273 ms
Wall time: 290 ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># build train, test, validation dataset, &quot;ds&quot;</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;./hellouniverse_stella_500/&#39;</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">stella</span><span class="o">.</span><span class="n">FlareDataSet</span><span class="p">(</span><span class="n">fn_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
                         <span class="n">catalog</span><span class="o">=</span><span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;Guenther_2020_flare_catalog.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading in training set files.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████████████████████████████| 62/62 [00:00&lt;00:00, 174.19it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>502 positive classes (flare)
1342 negative classes (no flare)
37.0% class imbalance
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">stella</span></code> dataset includes training, test and validation lightcurves (input vectors) and flare labels (output labels).
<code class="docutils literal notranslate"><span class="pre">stella</span></code> applies the necessary pre-processing to the lightcurves for input to the CNN model.
For more on how these are constructed, see <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">Feinstein et al. 2020</a>.
For our purposes (i.e., building the <code class="docutils literal notranslate"><span class="pre">stella</span></code> CNN from scratch to illustrate its structure and function), we first need to remove all lightcurves from the training, test and validation sets with NaN-valued inputs.
To do this, we loop through the data and select only lightcurves without NaNs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># remove lightcurves with NaNs from training, test and validation data</span>
<span class="k">def</span> <span class="nf">remove_nans</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Determine indices of files without NaNs&#39;&#39;&#39;</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">input_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx</span>


<span class="c1"># find indices in train, test and validation sets without NaNs</span>
<span class="n">idx_train</span> <span class="o">=</span> <span class="n">remove_nans</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">idx_test</span> <span class="o">=</span> <span class="n">remove_nans</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">idx_val</span> <span class="o">=</span> <span class="n">remove_nans</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">val_data</span><span class="p">)</span>

<span class="n">ds</span><span class="o">.</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>
<span class="n">ds</span><span class="o">.</span><span class="n">train_labels</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">train_labels</span><span class="p">[</span><span class="n">idx_train</span><span class="p">]</span>

<span class="n">ds</span><span class="o">.</span><span class="n">test_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_data</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>
<span class="n">ds</span><span class="o">.</span><span class="n">test_labels</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_labels</span><span class="p">[</span><span class="n">idx_test</span><span class="p">]</span>

<span class="n">ds</span><span class="o">.</span><span class="n">val_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">val_data</span><span class="p">[</span><span class="n">idx_val</span><span class="p">]</span>
<span class="n">ds</span><span class="o">.</span><span class="n">val_labels</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">val_labels</span><span class="p">[</span><span class="n">idx_val</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>To visualize the structure of the lightcurves in the training set, we plot a random selection of 16 examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select random image indices:</span>
<span class="n">example_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">train_labels</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># pull the lightcurves and labels for these selections</span>
<span class="n">example_lightcurves</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">example_ids</span><span class="p">]</span>
<span class="n">example_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">train_labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">example_ids</span><span class="p">]</span>


<span class="c1"># initialize your figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># loop through the randomly selected images and plot with labels</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">}</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Flare&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Non-flare&#39;</span><span class="p">}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">example_ids</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">example_lightcurves</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">example_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">example_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cadences&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Classifying_TESS_flares_with_CNNs_13_0.png" src="../../_images/Classifying_TESS_flares_with_CNNs_13_0.png" />
</div>
</div>
</div>
<div class="section" id="build-a-cnn-in-keras">
<h3>3. Build a CNN in <code class="docutils literal notranslate"><span class="pre">Keras</span></code><a class="headerlink" href="#build-a-cnn-in-keras" title="Permalink to this headline">¶</a></h3>
<p>Here, we will build the CNN model described in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">Feinstein et al. 2020</a> and implemented in <code class="docutils literal notranslate"><span class="pre">stella</span></code> from scratch.</p>
<p>Further details about Conv1D, MaxPooling1D, BatchNormalization, Dropout, and Dense layers can be found in the <a class="reference external" href="https://keras.io/api/layers/">Keras Layers Documentation</a>.
Further details about the sigmoid and softmax activation function can be found in the <a class="reference external" href="https://keras.io/api/layers/activations/">Keras Activation Function Documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># generate the model architecture</span>
<span class="c1"># Written for Keras 2</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">filter1</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">filter2</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">dense</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Define architecture for model</span>
<span class="n">data_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x_in</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)</span>
<span class="n">c0</span> <span class="o">=</span> <span class="n">Convolution1D</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">filter1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">)(</span><span class="n">x_in</span><span class="p">)</span>
<span class="n">b0</span> <span class="o">=</span> <span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">c0</span><span class="p">)</span>
<span class="n">d0</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">b0</span><span class="p">)</span>

<span class="n">c1</span> <span class="o">=</span> <span class="n">Convolution1D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">filter2</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">d0</span><span class="p">)</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">MaxPooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">c1</span><span class="p">)</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">b1</span><span class="p">)</span>


<span class="n">f</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">d1</span><span class="p">)</span>
<span class="n">z0</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)(</span><span class="n">z0</span><span class="p">)</span>
<span class="n">y_out</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)(</span><span class="n">d2</span><span class="p">)</span>

<span class="n">cnn</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">x_in</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">y_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-06-02 09:28:34.440376: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="compile-the-cnn">
<h3>4. Compile the CNN<a class="headerlink" href="#compile-the-cnn" title="Permalink to this headline">¶</a></h3>
<p>Next, we compile the model.
As in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">Feinstein et al. 2020</a>, we select the Adam optimizer and the binary cross entropy loss function (as this is a binary classification problem).</p>
<p>You can learn more about <a class="reference external" href="https://keras.io/api/optimizers/">optimizers</a> and more about <a class="reference external" href="https://keras.io/api/losses/">loss functions for regression tasks</a> in the <a class="reference external" href="https://keras.io/">Keras documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile Model</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;adam&#39;</span>
<span class="n">fit_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span> 
<span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;binary_crossentropy&#39;</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">fit_metrics</span><span class="p">)</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 input_1 (InputLayer)        [(None, 200, 1)]          0         
                                                                 
 conv1d (Conv1D)             (None, 200, 7)            119       
                                                                 
 max_pooling1d (MaxPooling1D  (None, 100, 7)           0         
 )                                                               
                                                                 
 dropout (Dropout)           (None, 100, 7)            0         
                                                                 
 conv1d_1 (Conv1D)           (None, 100, 3)            1347      
                                                                 
 max_pooling1d_1 (MaxPooling  (None, 50, 3)            0         
 1D)                                                             
                                                                 
 dropout_1 (Dropout)         (None, 50, 3)             0         
                                                                 
 flatten (Flatten)           (None, 150)               0         
                                                                 
 dense (Dense)               (None, 32)                4832      
                                                                 
 dropout_2 (Dropout)         (None, 32)                0         
                                                                 
 dense_1 (Dense)             (None, 1)                 33        
                                                                 
=================================================================
Total params: 6,331
Trainable params: 6,331
Non-trainable params: 0
_________________________________________________________________
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-the-cnn-to-perform-a-classification-task">
<h3>5. Train the CNN to perform a classification task<a class="headerlink" href="#train-the-cnn-to-perform-a-classification-task" title="Permalink to this headline">¶</a></h3>
<p>We will start with training for 20 epochs, but this almost certainly won’t be long enough to get great results.
Once you’ve run your model and evaluated the fit, you can come back here and run the next cell again for 100 epochs or longer.</p>
<p>You can learn more about <code class="docutils literal notranslate"><span class="pre">fit</span></code> <a class="reference external" href="https://keras.rstudio.com/reference/fit.html">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nb_epoch</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Train</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">cnn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">train_data</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">train_labels</span><span class="p">,</span>
                  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
                  <span class="n">epochs</span><span class="o">=</span><span class="n">nb_epoch</span><span class="p">,</span> 
                  <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">val_data</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">val_labels</span><span class="p">),</span> 
                  <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
23/23 [==============================] - 2s 30ms/step - loss: 0.6105 - accuracy: 0.7247 - val_loss: 0.6087 - val_accuracy: 0.7088
Epoch 2/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5960 - accuracy: 0.7309 - val_loss: 0.6074 - val_accuracy: 0.7088
Epoch 3/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5929 - accuracy: 0.7302 - val_loss: 0.6090 - val_accuracy: 0.7088
Epoch 4/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5840 - accuracy: 0.7316 - val_loss: 0.6011 - val_accuracy: 0.7088
Epoch 5/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5824 - accuracy: 0.7316 - val_loss: 0.5974 - val_accuracy: 0.7088
Epoch 6/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5773 - accuracy: 0.7343 - val_loss: 0.5929 - val_accuracy: 0.7143
Epoch 7/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5733 - accuracy: 0.7363 - val_loss: 0.5897 - val_accuracy: 0.7143
Epoch 8/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5613 - accuracy: 0.7432 - val_loss: 0.5860 - val_accuracy: 0.7143
Epoch 9/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5575 - accuracy: 0.7452 - val_loss: 0.5893 - val_accuracy: 0.7143
Epoch 10/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5640 - accuracy: 0.7466 - val_loss: 0.5795 - val_accuracy: 0.7143
Epoch 11/20
23/23 [==============================] - 0s 13ms/step - loss: 0.5451 - accuracy: 0.7507 - val_loss: 0.5688 - val_accuracy: 0.7143
Epoch 12/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5449 - accuracy: 0.7527 - val_loss: 0.5723 - val_accuracy: 0.7143
Epoch 13/20
23/23 [==============================] - 0s 15ms/step - loss: 0.5395 - accuracy: 0.7582 - val_loss: 0.5604 - val_accuracy: 0.7308
Epoch 14/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5337 - accuracy: 0.7609 - val_loss: 0.5526 - val_accuracy: 0.7308
Epoch 15/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5224 - accuracy: 0.7650 - val_loss: 0.5398 - val_accuracy: 0.7308
Epoch 16/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5129 - accuracy: 0.7712 - val_loss: 0.5288 - val_accuracy: 0.7363
Epoch 17/20
23/23 [==============================] - 0s 14ms/step - loss: 0.4992 - accuracy: 0.7766 - val_loss: 0.5281 - val_accuracy: 0.7363
Epoch 18/20
23/23 [==============================] - 0s 14ms/step - loss: 0.5009 - accuracy: 0.7814 - val_loss: 0.5224 - val_accuracy: 0.7418
Epoch 19/20
23/23 [==============================] - 0s 14ms/step - loss: 0.4858 - accuracy: 0.7937 - val_loss: 0.5075 - val_accuracy: 0.7637
Epoch 20/20
23/23 [==============================] - 0s 14ms/step - loss: 0.4708 - accuracy: 0.8005 - val_loss: 0.4849 - val_accuracy: 0.7637
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the model to file</span>
<span class="n">cnn_file</span> <span class="o">=</span> <span class="s1">&#39;flare_model.h5&#39;</span>
<span class="n">cnn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cnn_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="test-the-cnn-performance">
<h3>6. Test the CNN performance<a class="headerlink" href="#test-the-cnn-performance" title="Permalink to this headline">¶</a></h3>
<p>Apply the CNN to predict flares on the “test” set, not used for training or validating the CNN, and evaluate the performance using a confusion matrix.
See the documentation from <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.confusion_matrix.html">sklearn on confusion matrices</a> for more information.
The code for generating and plotting the confusion matrix below was adapted from the application by <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020A%26C....3200390C/abstract">Ciprijanovic et al. 2020</a> for <a class="reference external" href="https://github.com/deepskies/deepmerge-public">DeepMerge</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">cnn</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">input_labels</span><span class="p">):</span>
    
    <span class="c1"># Compute flare predictions for the test dataset</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">cnn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="c1"># Convert to binary classification </span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictions</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span> 
    
    <span class="c1"># Compute the confusion matrix by comparing the test labels (ds.test_labels) with the test predictions</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">input_labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

    <span class="c1"># Normalize the confusion matrix results. </span>
    <span class="n">cm_norm</span> <span class="o">=</span> <span class="n">cm</span> <span class="o">/</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    
    <span class="c1"># Plotting</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">cm_norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;binary_r&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion matrix&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;Flare&#39;</span><span class="p">,</span> <span class="s1">&#39;No Flare&#39;</span><span class="p">])</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;Flare&#39;</span><span class="p">,</span> <span class="s1">&#39;No Flare&#39;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>

    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm_norm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm_norm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm_norm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">cm_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fmt</span><span class="p">),</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">cm_norm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">cnn</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6/6 [==============================] - 0s 6ms/step
</pre></div>
</div>
<img alt="../../_images/Classifying_TESS_flares_with_CNNs_23_1.png" src="../../_images/Classifying_TESS_flares_with_CNNs_23_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>The results don’t look great… why?</strong> From the confusion matrix in Section 6, when faced with the test dataset (i.e., data not used for training or validation), the model predicts a large fraction of false positive flare events, and consequently not enough true negative flare events).
The published models from <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2347F/abstract">Feinstein et al. 2020</a> perform <em>much better</em>, and the confusion matrix <strong>should look more like the results shown below</strong>.
We note that in this notebook we are using a subset of the available training data, and we are training the model for only a subset of the optimal number of epochs for space and time considerations, but you are welcome to augment these restrictions, and as always check out <a class="reference external" href="https://adina.feinste.in/stella/">the <code class="docutils literal notranslate"><span class="pre">stella</span></code> repository</a> for more information!</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_url</span> <span class="o">=</span> <span class="s1">&#39;https://archive.stsci.edu/hlsps/stella/hlsp_stella_tess_ensemblemodel_s042_tess_v0.1.0_cnn.h5&#39;</span>
<span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">download_file</span><span class="p">(</span><span class="n">file_url</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">test_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6/6 [==============================] - 0s 3ms/step
</pre></div>
</div>
<img alt="../../_images/Classifying_TESS_flares_with_CNNs_25_1.png" src="../../_images/Classifying_TESS_flares_with_CNNs_25_1.png" />
</div>
</div>
<ul class="simple">
<li><p><strong>Can I improve the model by increasing the number of epochs its training for?</strong>
We only trained for 20 epochs, which is many fewer than the published model.
Go back to Section 4 (“Train the CNN to perform a classification task”) and increase the number of epochs to 100 (or more!) and train again.
Does your model perform better?
Your results may look better/worse/different from the published results due to the stochastic nature of training.</p></li>
<li><p><strong>Can I try a different model?  I think the results could be improved.</strong>
Yes! You can try adding layers, swapping out the max pooling, changing the activation functions, swapping out the loss function, or trying a different optimizer or learning rate.
Experiment and see what model changes give the best results.
You should be aware: when you start training again, you pick up where your model left off.
If you want to “reset” your model to epoch 0 and random weights, you should run the cells to make and compile the model again.</p></li>
<li><p><strong>I want to test my model on my training data!</strong>
No.
You will convince yourself that your results are much better than they actually are.
Always keep your training, validation, and testing sets completely separate!</p></li>
</ul>
</div>
<div class="section" id="extensions-exercises">
<h2>Extensions/Exercises<a class="headerlink" href="#extensions-exercises" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Is the model “overfitting”?</strong>
Using the results of the model’s <code class="docutils literal notranslate"><span class="pre">history</span></code> (saved as a result of the model training process), investigate the behavior of the training and validation losses and accuracies as a function of training epoch.
Make a plot or two!
How do the training and validation losses compare?
How do the training and validation accuracies compare?
If the loss for the validation set is higher than for the training set (and conversely, the accuracy for the validation set is lower than for the training set), the model may be suffering from <a class="reference external" href="https://www.tensorflow.org/tutorials/keras/overfit_and_underfit">overfitting</a>.</p></li>
<li><p><strong>Try applying this model to a new dataset</strong>
Using the built-in functionality provided by the <code class="docutils literal notranslate"><span class="pre">stella</span></code> package, you can pre-process your own 2-minute cadence TESS light curves and predict flares.
An example workflow is shown below:</p></li>
</ul>
<div class="section" id="predict-flares-in-a-new-dataset">
<h3>7. Predict flares in a new dataset<a class="headerlink" href="#predict-flares-in-a-new-dataset" title="Permalink to this headline">¶</a></h3>
<p>In this step, we will download light curves directly from TESS, pre-process them with <code class="docutils literal notranslate"><span class="pre">stella</span></code> for input to the CNN, and predict flares.
The sample is a set of bright M dwarfs not featured in the training/validation/tests datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ticids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;120461526&#39;</span><span class="p">,</span> <span class="s1">&#39;278779899&#39;</span><span class="p">,</span> <span class="s1">&#39;139754153&#39;</span><span class="p">,</span> <span class="s1">&#39;273418879&#39;</span><span class="p">,</span> <span class="s1">&#39;52121469&#39;</span><span class="p">,</span> <span class="s1">&#39;188580272&#39;</span><span class="p">,</span> <span class="s1">&#39;394015919&#39;</span><span class="p">,</span> <span class="s1">&#39;183564259&#39;</span><span class="p">,</span> <span class="s1">&#39;402104884&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for all the selected targets, pull the available lightcurves using the lightkurve package</span>
<span class="n">lcs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ticids</span><span class="p">:</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">search_lightcurve</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s1">&#39;TIC&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">,</span> <span class="n">mission</span><span class="o">=</span><span class="s1">&#39;TESS&#39;</span><span class="p">,</span> <span class="n">sector</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">download_all</span><span class="p">()</span>
    <span class="n">lcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD - 2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;e-/s&#39; did not parse as fits unit: At col 0, Unit &#39;e&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;pixels&#39; did not parse as fits unit: At col 0, Unit &#39;pixels&#39; not supported by the FITS standard. Did you mean pixel? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;BJD-2457000, days&#39; did not parse as fits unit: At col 0, Unit &#39;BJD&#39; not supported by the FITS standard.  If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
WARNING: UnitsWarning: &#39;ppm&#39; did not parse as fits unit: At col 0, Unit &#39;ppm&#39; not supported by the FITS standard. Did you mean Pm or pm? If this is meant to be a custom unit, define it with &#39;u.def_unit&#39;. To have it recognized inside a file reader or other code, enable it with &#39;u.add_enabled_units&#39;. For details, see https://docs.astropy.org/en/latest/units/combining_and_defining.html [astropy.units.core]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the CNN using `stella`</span>
<span class="n">cnn_stella</span> <span class="o">=</span> <span class="n">stella</span><span class="o">.</span><span class="n">ConvNN</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lcs</span><span class="p">):</span>
    <span class="c1"># pull out on the first light curve in each set, if more than one exist</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">lc</span> <span class="o">=</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># predict the flare probability light cuvey for the input data using `stella` </span>
    <span class="c1"># (which applies the necessary pre-processing to the data for input to the CNN)</span>
    <span class="n">cnn_stella</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cnn_file</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fluxes</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">errs</span><span class="o">=</span><span class="n">lc</span><span class="o">.</span><span class="n">flux_err</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cnn_stella</span><span class="o">.</span><span class="n">predict_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cnn_stella</span><span class="o">.</span><span class="n">predict_flux</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cnn_stella</span><span class="o">.</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.</span> <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Probability of Flare&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [BJD-2457000]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Flux&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TIC </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="o">.</span><span class="n">targetid</span><span class="p">));</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 4ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.82s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.46s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.05s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.41s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.21s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.50s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:05&lt;00:00,  5.13s/it]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>39/39 [==============================] - 0s 4ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00,  3.03it/s]
  0%|                                                                                         | 0/1 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>572/572 [==============================] - 2s 3ms/step
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████████████████████████| 1/1 [00:04&lt;00:00,  4.68s/it]
</pre></div>
</div>
<img alt="../../_images/Classifying_TESS_flares_with_CNNs_32_19.png" src="../../_images/Classifying_TESS_flares_with_CNNs_32_19.png" />
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>FAQ<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Why does the data near gaps have a high probability of being flares?</strong>
This isn’t necessarily the case.
The issue here is that <code class="docutils literal notranslate"><span class="pre">stella</span></code> needs 100 data points on either side of a given cadence to create an “example” (those 200 cadence samples we trained on).
When there’s a gap in the data, the first 100 points can’t be centered in each example properly.
As such, <code class="docutils literal notranslate"><span class="pre">stella</span></code> cannot accurately predict flares in these data and skips it.</p></li>
<li><p><strong>But what if there are flares near the data gaps?</strong>
There may very well be flares towards the data gaps!
Unfortunately, <code class="docutils literal notranslate"><span class="pre">stella</span></code> cannot find those for you at present, and you’ll need to identify those yourself.</p></li>
</ul>
</div>
<div class="section" id="about-this-notebook">
<h2>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">¶</a></h2>
<p><strong>Author:</strong><br />
Claire Murray, Data Scientist, <a class="reference external" href="mailto:cmurray1&#37;&#52;&#48;stsci&#46;edu">cmurray1<span>&#64;</span>stsci<span>&#46;</span>edu</a></p>
<p><strong>Additional Contributors:</strong><br />
Yotam Cohen, STScI Staff Scientist, <a class="reference external" href="mailto:ycohen&#37;&#52;&#48;stsci&#46;edu">ycohen<span>&#64;</span>stsci<span>&#46;</span>edu</a></p>
<p><strong>Info:</strong><br />
This notebook is based on the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2347F/abstract"><code class="docutils literal notranslate"><span class="pre">stella</span></code></a> software package for the CNN used in <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">“Flare Statistics for Young Stars from a Convolutional Neural Network Analysis of TESS Data”</a>, Adina D. Feinstein et al. Astronomical Journal, Volume 160, Issue 5, November 2020, and the notebook “CNN_for_cluster_masses” by Michelle Ntampaka, Data Scientist, <a class="reference external" href="mailto:mntampaka&#37;&#52;&#48;stsci&#46;edu">mntampaka<span>&#64;</span>stsci<span>&#46;</span>edu</a>.</p>
<p><strong>Updated On:</strong> 2022-5-25</p>
</div>
<div class="section" id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this headline">¶</a></h2>
<p>If you use this CNN, <code class="docutils literal notranslate"><span class="pre">stella</span></code>, <code class="docutils literal notranslate"><span class="pre">astropy</span></code>, or <code class="docutils literal notranslate"><span class="pre">keras</span></code> for published research, please cite the
authors. Follow these links for more information:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020AJ....160..219F/abstract">Citing the CNN</a></p></li>
<li><p><a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020JOSS....5.2347F/abstract">Citing <code class="docutils literal notranslate"><span class="pre">stella</span></code></a></p></li>
<li><p><a class="reference external" href="https://www.astropy.org/acknowledging.html">Citing <code class="docutils literal notranslate"><span class="pre">astropy</span></code></a></p></li>
<li><p><a class="reference external" href="https://keras.io/getting_started/faq/#how-should-i-cite-keras">Citing <code class="docutils literal notranslate"><span class="pre">keras</span></code></a></p></li>
</ul>
<p><a class="reference external" href="#top">Top of Page</a>
<img style="float: right;" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" alt="Space Telescope Logo" width="200px"/></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/hello-universe"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By STScI Notebook Dev<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>